"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TuyaIRPlatform=void 0;const TuyaIRDiscovery_1=require("./lib/TuyaIRDiscovery"),AirConditionerAccessory_1=require("./lib/accessories/AirConditionerAccessory"),FanAccessory_1=require("./lib/accessories/FanAccessory"),GenericAccessory_1=require("./lib/accessories/GenericAccessory"),DoItYourselfAccessory_1=require("./lib/accessories/DoItYourselfAccessory"),LightAccessory_1=require("./lib/accessories/LightAccessory"),PLATFORM_NAME="TuyaIR",PLUGIN_NAME="homebridge-tuya-ir",CLASS_DEF={infrared_ac:AirConditionerAccessory_1.AirConditionerAccessory,infrared_fan:FanAccessory_1.FanAccessory,qt:DoItYourselfAccessory_1.DoItYourselfAccessory,infrared_light:LightAccessory_1.LightAccessory};class TuyaIRPlatform{constructor(s,e,i){this.log=s,this.config=e,this.api=i,this.Service=this.api.hap.Service,this.Characteristic=this.api.hap.Characteristic,this.accessories=[],this.cachedAccessories=new Map,this.foundAccessories=[],this.log.debug("Finished initializing platform:",this.config.name),this.api.on("didFinishLaunching",(()=>{s.debug("Executed didFinishLaunching callback"),this.discoverDevices()}))}configureAccessory(s){this.log.info("Loading accessory from cache:",s.displayName),this.accessories.push(s)}discoverDevices(){if(!this.config.tuyaAPIClientId)return this.log.error("Client ID is not configured. Please check your config.json");if(!this.config.tuyaAPISecret)return this.log.error("Client Secret is not configured. Please check your config.json");if(!this.config.deviceRegion)return this.log.error("Region is not configured. Please check your config.json");this.log.info("Starting discovery...");const s=new TuyaIRDiscovery_1.TuyaIRDiscovery(this.log,this.config);this.discover(s,0,this.config.smartIR.length)}discover(s,e,i){this.log.debug(`Starting discovery for device number ${e}`),s.startDiscovery(e,((c,o)=>{for(const s of c)if(s){s.ir_id=this.config.smartIR[o].deviceId;const e=CLASS_DEF[s.category]||(s.diy?DoItYourselfAccessory_1.DoItYourselfAccessory:GenericAccessory_1.GenericAccessory),i=this.api.hap.uuid.generate(s.id),c=this.accessories.find((s=>s.UUID===i));if(c)this.log.info("Restoring existing accessory from cache:",c.displayName),c.context.device=s,this.foundAccessories.push(c),e?(this.api.updatePlatformAccessories([c]),new e(this,c)):(this.api.unregisterPlatformAccessories(PLUGIN_NAME,"TuyaIR",[c]),this.log.warn(`Removing unsupported accessory '${c.displayName}'...`));else if(e){this.log.info("Adding new accessory:",s.name);const c=new this.api.platformAccessory(s.name,i);c.context.device=s,new e(this,c),this.api.registerPlatformAccessories(PLUGIN_NAME,"TuyaIR",[c])}else this.log.warn(`Unsupported accessory '${s.name}'...`)}if(++e<i)this.discover(s,e,i);else{const s=this.accessories.filter((s=>!this.foundAccessories.some((e=>e.UUID===s.UUID))));s.length>0&&(this.log.info(`Removing ${s.length} accessories as they are no longer configured...`),this.api.unregisterPlatformAccessories(PLUGIN_NAME,"TuyaIR",s)),this.foundAccessories.splice(0,this.foundAccessories.length)}}))}}exports.TuyaIRPlatform=TuyaIRPlatform;